# Fluentd config file for OMS Docker - container components (non kubeAPI)

# Forward port 25225 for container logs
<source>
	type forward
	port 25225
	bind 127.0.0.1
</source>

# Container inventory
<source>
  type containerinventory
  tag oms.containerinsights.containerinventory
  run_interval 60s
  log_level debug
</source>

#cadvisor perf
<source>
	type cadvisorperf
	tag oms.api.cadvisorperf
	run_interval 60s
  log_level debug
</source>

#custom_metrics_mdm filter plugin
<filter mdm.cadvisorperf**>
  type filter_cadvisor2mdm
  custom_metrics_azure_regions eastus,southcentralus,westcentralus,westus2,southeastasia,northeurope,westEurope
  metrics_to_collect cpuUsageNanoCores,memoryWorkingSetBytes,memoryRssBytes
  log_level info
</filter>

<source>
  type dockerhealth
  tag oms.api.DockerHealth
  run_interval 60s
  log_level debug
</source>

<source>
  type nodehealthcpuutilization
  tag oms.api.NodeHealthCpuUtilization
  run_interval 60s
  log_level debug
</source>

<match oms.containerinsights.containerinventory**>
  type out_oms
  log_level debug
  num_threads 5
  buffer_chunk_limit 20m
  buffer_type file
  buffer_path %STATE_DIR_WS%/out_oms_containerinventory*.buffer
  buffer_queue_limit 20
  buffer_queue_full_action drop_oldest_chunk
  flush_interval 20s
  retry_limit 10
  retry_wait 30s
  max_retry_wait 9m
</match>

<match oms.api.cadvisorperf**>
  type out_oms
  log_level debug
  num_threads 5
  buffer_chunk_limit 20m
  buffer_type file
  buffer_path %STATE_DIR_WS%/out_oms_cadvisorperf*.buffer
  buffer_queue_limit 20
  buffer_queue_full_action drop_oldest_chunk
  flush_interval 20s
  retry_limit 10
  retry_wait 30s
  max_retry_wait 9m
</match>

<match mdm.cadvisorperf**>
  type out_mdm
  log_level debug
  num_threads 5
  buffer_chunk_limit 20m
  buffer_type file
  buffer_path %STATE_DIR_WS%/out_mdm_cdvisorperf*.buffer
  buffer_queue_limit 20
  buffer_queue_full_action drop_oldest_chunk
  flush_interval 20s
  retry_limit 10
  retry_wait 30s
  max_retry_wait 9m
  retry_mdm_post_wait_minutes 60
</match>

<match oms.api.DockerHealth**>
  type out_oms_api
  log_level debug
  buffer_chunk_limit 10m
  buffer_type file
  buffer_path /var/opt/microsoft/omsagent/b539903f-ee4d-424f-b48f-a6410acd9025/state/out_oms_api_docker_health*.buffer
  buffer_queue_limit 10
  flush_interval 20s
  retry_limit 10
  retry_wait 30s
</match>

<match oms.api.NodeHealthCpuUtilization**>
  type out_oms_api
  log_level debug
  buffer_chunk_limit 10m
  buffer_type file
  buffer_path /var/opt/microsoft/omsagent/b539903f-ee4d-424f-b48f-a6410acd9025/state/out_oms_api_node_health_cpu_utilization*.buffer
  buffer_queue_limit 10
  flush_interval 20s
  retry_limit 10
  retry_wait 30s
</match>
